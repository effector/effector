---
import type { MarkdownHeading } from "astro";
import { getPathParamsFromId, createChangeLangLinks, getTextLocalized } from "../../languages";
import { getActiveTabSidebar, getLocalizedPanelSidebar } from "../../navigation";
import { DOCS_VERSIONS } from "../../navigation";
import { trimTrailingSlash } from "src/libs/path";
import { PANEL_ITEMS } from "src/sidebar-config";
import { PANEL_FRAMEWORK_ITEMS } from "src/sidebar-config";
import SidebarScrollRestore from "./SidebarScrollRestore.astro";

import EffectorLogo from "../Header/EffectorLogo.astro";
import Search from "../Header/Search.astro";
import ThemeSwitch from "../Header/ThemeSwitch.astro";
import DropDownMenu from "../DropDownMenu.astro";

import ChevronRight from "src/icons/ChevronRight.astro";
import StatusNew from "src/icons/StatusNew.astro";
import StatusDeprecated from "src/icons/StatusDeprecated.astro";
import IconLanguage from "@icons/Language.astro";

type Props = {
  currentPage: string;
  headings: MarkdownHeading[];
};

const { currentPage } = Astro.props;
const currentPageMatch = trimTrailingSlash(currentPage);

const { slug, lang } = getPathParamsFromId(Astro.url.pathname);
const activePanelIndex = getActiveTabSidebar(slug);
const localizedSidebar = await getLocalizedPanelSidebar(slug, lang);
const languageLinks = createChangeLangLinks({ slug });
---

<tabbed-sidebar id="sidebar" class="navigation">
  <nav aria-labelledby="grid-left" class="sidebar-container">
    <div class="sidebar-header">
      <a class="logo-link" href={lang === "en" ? "/" : `/${lang}`}>
        <EffectorLogo size={32} />
        <span class="logo-text">effector</span>
      </a>
    </div>
    <div class="sidebar-search">
      <Search />
    </div>
    <div class="nav-content">
      <div class="main-tabs">
      <ul class="tabs navigation-panel">
        {
          PANEL_ITEMS.map(({ text, id }, i) => (
            <li role="presentation">
              <button
                role="tab"
                class="tab-panel-item"
                aria-selected={id === activePanelIndex ? "true" : "false"}
              >
                {text[lang as keyof typeof text] || text.en}
              </button>
            </li>
          ))
        }
        <li role="presentation">
          <ul class="frameworks-panel">
            {
              PANEL_FRAMEWORK_ITEMS.map(({ text, id, Icon }, i) => (
                <li role="presentation">
                  <button
                    role="tab"
                    class="tab-panel-item"
                    data-icon={id}
                    data-active={i === 0 ? "true" : "false"}
                    aria-selected={id === activePanelIndex ? "true" : "false"}
                  >
                    {Icon && <Icon size={16} />}
                    <span>{text[lang as keyof typeof text] || text.en}</span>
                  </button>
                </li>
              ))
            }
          </ul>
        </li>
      </ul>
    </div>
    <div class="tab-content">
      {
        localizedSidebar.map(({ sidebarItems, panelId }) => (
          <div
            hidden={panelId !== activePanelIndex}
            data-initial={panelId === activePanelIndex ? "true" : "false"}
            role="tabpanel"
          >
            <ul class="nav-groups">
              {sidebarItems.map((group, index) => {
                const isCollapsed = Boolean(group.collapsed);
                return (
                  <li>
                    <div class="nav-group">
                      <button
                        class="nav-group-title"
                        class:list={{ collapsed: isCollapsed }}
                        aria-expanded={`${!isCollapsed}`}
                        aria-controls={`group-${index}`}
                      >
                        {group.title}
                        <ChevronRight class="arrow" />
                      </button>
                      <ul
                        id={`group-${index}`}
                        class:list={{ collapsed: isCollapsed }}
                        aria-hidden={isCollapsed ? "true" : "false"}
                      >
                        {group.items.map((item) => (
                          <li class="nav-link">
                            <a
                              href={item.link}
                              aria-current={currentPageMatch === item.link ? "page" : false}
                              target={item.link.startsWith("/") ? undefined : "_blank"}
                              data-fallback={item.isFallback}
                              data-status={item.status}
                              tabindex={isCollapsed ? "-1" : undefined}
                            >
                              <span> {item.title}</span>
                              {item.status === "new" && <StatusNew class="status-badge" size={20} />}
                              {item.status === "deprecated" && <StatusDeprecated size={20} class="status-badge" />}
                            </a>
                          </li>
                        ))}
                      </ul>
                    </div>
                  </li>
                );
              })}
            </ul>
          </div>
        ))
      }
    </div>
    </div>
    <div class="sidebar-footer">
      <div class="footer-group">
        <DropDownMenu links={DOCS_VERSIONS}>v23.x</DropDownMenu>
        <DropDownMenu links={languageLinks}>
          <IconLanguage />
        </DropDownMenu>
      </div>
      <ThemeSwitch />
    </div>
  </nav>
  <SidebarScrollRestore />
</tabbed-sidebar>

<script>
  import { Tabs } from "@components/Tabs/Tabs";
  class TabbedSidebar extends Tabs {}

  customElements.define("tabbed-sidebar", TabbedSidebar);

  function setupNavigation() {
    const navGroups = document.querySelectorAll(".nav-group");
    navGroups.forEach((group) => {
      const button = group.querySelector("button");
      const content = group.querySelector("ul");
      if (!button || !content) return;

      const updateState = (expanded:boolean) => {
        button.setAttribute("aria-expanded", expanded.toString());
        button.classList.toggle("collapsed", !expanded);
        content.classList.toggle("collapsed", !expanded);
        content.setAttribute("aria-hidden", (!expanded).toString());
        content.querySelectorAll("a").forEach((link) => {
          link.setAttribute("tabindex", expanded ? "0" : "-1");
        });
      };

      const initialExpanded = button.getAttribute("aria-expanded") === "true";
      updateState(initialExpanded);

      button.addEventListener("click", () => {
        const expanded = button.getAttribute("aria-expanded") === "true";
        updateState(!expanded);
      });
    });
  }

  document.addEventListener("DOMContentLoaded", setupNavigation);
  document.addEventListener("astro:after-swap", setupNavigation);
</script>

<style>
  .footer-group{
    display: flex;
    gap:var(--space-2)
  }

  .tab-content{
    margin-top: var(--space-4);
  }

  #sidebar{
    border-radius: var(--radius-2xl);
    position: relative;
    background-color: var(--theme-bg-sidebar-tabs-bg);
    box-shadow: var(--theme-sidebar-shadow, none);
  }

  #sidebar::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 50%;
    height: 40%;
    background: radial-gradient(
      ellipse at top right,
      hsla(var(--color-primary-500), 0.1) 0%,
      hsla(var(--color-primary-500), 0.04) 40%,
      transparent 70%
    );
    pointer-events: none;
    z-index: 1;
    border-radius: var(--radius-2xl);
  }

  #sidebar::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: var(--radius-2xl);
    padding: 1px;
    background: radial-gradient(
      ellipse at top right,
      hsla(var(--color-primary-500), 0.3) 0%,
      hsla(var(--color-primary-500), 0.15) 30%,
      var(--theme-sidebar-border) 60%
    );
    -webkit-mask:
      linear-gradient(#fff 0 0) content-box,
      linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
    z-index: 0;
  }

  .sidebar-container{
    padding: var(--space-2);
    position: relative;
    z-index: 2;
  }

  .navigation {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    width: 100%;
  }

  nav {
    display: flex;
    flex-direction: column;
    height: 100%;
    font-size: var(--text-sidebar-content) !important;
  }

  .sidebar-header {
    padding: var(--space);
    flex-shrink: 0;
  }

  .logo-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    text-decoration: none;
    transition: opacity 0.2s;
  }

  .logo-link:hover {
    opacity: 0.8;
  }

  .logo-text {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--theme-text);
  }

  .main-tabs {
    flex-shrink: 0;
  }

  .frameworks-panel {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(2, 1fr);
    gap: 0.25rem;
  }

  .frameworks-panel :global(svg) {
    width: 14px;
    height: 14px;
  }

  .frameworks-panel li {
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
  }

  .navigation-panel {
    width: 100%;
    border-radius: 16px;
    padding: 0.25rem;
    background-color: var(--theme-bg-sidebar-main-tabs);
    border: 1px solid var(--theme-sidebar-surface-border, var(--theme-sidebar-border));
  }

  .navigation-panel button {
    font-size: var(--text-sidebar-content);
  }

  .tabs {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .navigation-panel li {
    padding: 0;
    border-radius: 12px;
    width: 100%;
  }

  .navigation-panel li button {
    width: 100%;
    padding: var(--space-2) var(--space-3);
    background-color: transparent;
    color: var(--theme-left-sidebar-item-text);
    border-radius: 12px;
  }
  .navigation-panel li button:hover {
    background-color: var(--theme-bg-sidebar-main-tabs-active);
  }

  .navigation-panel li button[aria-selected="true"] {
    background-color: var(--theme-bg-sidebar-main-tabs-active);
    color: var(--theme-text);
    box-shadow: var(--theme-sidebar-tab-shadow, none);
  }

  .tab-panel-item {
    cursor: pointer;
    @apply flex font-bold;
  }

  
  .sidebar-search {
    margin-top: var(--space-4);
    flex-shrink: 0;
    border: 1px solid var(--theme-sidebar-surface-border, var(--theme-sidebar-border));
    border-radius: var(--radius-2xl);
    margin-bottom: var(--space-4);
    background-color: var(--theme-bg-sidebar-main-tabs);
  }

  .sidebar-search :global(button[data-open-modal]) {
    width: 100%;
    justify-content: flex-start;
    background-color: transparent;
    border: none;
  }

  .nav-content {
    flex: 1;
    overflow-y: auto;
    overflow-x: visible;
    overscroll-behavior: contain;
    scrollbar-gutter: stable;
    padding-bottom: var(--space-4);
  }

  .nav-groups {
    --fast-ease: cubic-bezier(0, 0.18, 0.25, 1);
    padding: 0;
  }

  .nav-groups > li + li {
    margin-top: var(--space-2);
  }

  .nav-group {
    @apply flex flex-col;
  }

  .nav-group-title {
    @apply rounded-md py-1;
    margin: 0;
    padding-left: 1rem;
    padding-right: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    font-weight: normal;
    font-size: var(--text-sidebar-content);
    background: none;
    border: none;
    cursor: pointer;
    text-align: left;
  }

  .nav-group-title:hover,
  .nav-group-title:focus-visible {
    background-color: var(--theme-bg-sidebar-main-tabs-active);
  }

  .nav-group-title .arrow {
    width: 1em;
    height: 1em;
    transition: transform 0.2s var(--fast-ease);
  }

  .nav-group-title.collapsed .arrow {
    transform: rotate(90deg);
  }

  .nav-group ul {
    display: flex;
    flex-direction: column;
    transition:
      max-height 0.2s var(--fast-ease),
      opacity 0.2s var(--fast-ease);
    max-height: 1000px;
    overflow: hidden;
    opacity: 1;
  }

  .nav-group ul.collapsed {
    max-height: 0;
    opacity: 0;
    pointer-events: none;
  }

  .nav-link a {
    @apply flex items-center rounded-md py-1 text-base;
    padding-left: 1.75rem;
    padding-right: 1rem;
    color: var(--theme-left-sidebar-item-text);
    font: inherit;
    text-decoration: none;
    justify-content: space-between;
    gap: 0.5rem;
  }

  .nav-link a[data-fallback] span:after {
    content: "EN";
    font-weight: bold;
    font-size: var(--text-sidebar-translation-slug);
    vertical-align: super;
    margin-left: 5px;
  }

  .nav-link a:hover,
  .nav-link a:focus {
    background-color: var(--theme-bg-sidebar-main-tabs-active);
  }

  .nav-link a[aria-current="page"] {
    background-color: var(--theme-sidebar-active-bg);
    color: var(--theme-sidebar-active-text);
    font-weight: 600;
  }

  .nav-link a[href^="http://"]::after,
    .nav-link a[href^="https://"]::after
  {
    display: inline-block;
    background-image: url("/external.svg");
    background-position: center;
    background-size: contain;
    background-repeat: no-repeat;
    width: 1em;
    height: 1em;
    content: "";
  }

  :global(.theme-dark) .nav-link a[href^="http://"]::after,
    :global(.theme-dark) .nav-link a[href^="https://"]::after
  {
    filter: invert();
  }

  /* ========================================
     STATUS BADGES
     ======================================== */

  .nav-link a :global(.status-badge) {
    flex-shrink: 0;
    margin-left: auto;
    padding-left: 0.5rem;
    opacity: 0.6;
    transition: opacity 200ms ease;
  }

  .nav-link a[data-status="new"] :global(.status-badge) {
    color: var(--theme-status-new);
  }

  .nav-link a[data-status="deprecated"] :global(.status-badge) {
    color: var(--theme-status-deprecated);
  }

  .nav-link a:hover :global(.status-badge),
  .nav-link a:focus :global(.status-badge) {
    opacity: 0.8;
  }

  .nav-link a[aria-current="page"] :global(.status-badge) {
    opacity: 1;
    color: inherit;
  }

  .sidebar-footer {
    display: flex;
    justify-content: space-between;
    padding-top:var(--space-2);
    border-top: 1px solid var(--theme-sidebar-surface-border, var(--theme-sidebar-border));
    flex-shrink: 0;
  }

  .sidebar-footer :global(button) {
    width: 100%;
    height: 30px;
    min-height: 30px;
    border: 1px solid var(--theme-sidebar-surface-border, var(--theme-sidebar-border));
    border-radius: 9999px;
    font-size: var(--font-size-sm) !important;
  }

  .sidebar-footer :global(svg) {
    width: 16px;
    height: 16px;
  }

  .sidebar-footer :global(.theme-switch) {
    min-height: 30px;
    min-width: 30px;
  }

  .sidebar-footer :global(.theme-switch .toggle-button) {
    width: 32px;
    height: 32px;
    padding: 0;
  }

  .sidebar-footer :global(.menu-button) {
    padding: 0.125rem 0.375rem;
  }
</style>
