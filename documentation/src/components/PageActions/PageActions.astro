---
import DropDownMenu from "../DropDownMenu.astro";
import ChevronDown from "@icons/ChevronDown.astro";
import IconCopy from "@icons/Copy.astro";
import IconCheck from "@icons/Check.astro";
import { getTextLocalized, translations } from "../../languages";

interface Props {
  documentId?: string;
  lang?: string;
}

const { documentId } = Astro.props as Props;

// Get current page URL for AI prompts
const currentUrl = new URL(Astro.url.pathname, Astro.site).href;
const prompt = `Read ${currentUrl}, I want to ask questions about it.`;
const encodedPrompt = encodeURIComponent(prompt);

// Extract slug from the current document ID or fallback to the pathname
const normalizedDocumentId = documentId
  ? documentId.replace(/^\/*/, "").replace(/\.mdx?$/i, "")
  : null;

const pathname = Astro.url.pathname;
const pathSegments = pathname.split("/").filter(Boolean);
const lang = pathSegments[0] || "en";
const fallbackSlug = pathSegments.slice(1).join("/");
const fallbackFullSlug = fallbackSlug ? `${lang}/${fallbackSlug}` : lang;
const finalSlug = normalizedDocumentId ?? fallbackFullSlug;

const copyMarkdownText = getTextLocalized(translations.PageActions.CopyMarkdown, lang);
const copyingText = getTextLocalized(translations.PageActions.Copying, lang);
const copiedText = getTextLocalized(translations.PageActions.Copied, lang);
const errorText = getTextLocalized(translations.PageActions.Error, lang);
const askAIText = getTextLocalized(translations.PageActions.AskAI, lang);

// AI options with links
const aiLinks = [
  {
    text: { en: "ChatGPT", ru: "ChatGPT", uz: "ChatGPT" },
    link: `https://chatgpt.com/?hints=search&q=${encodedPrompt}`,
  },
  {
    text: { en: "Claude", ru: "Claude", uz: "Claude" },
    link: `https://claude.ai/new?q=${encodedPrompt}`,
  },
];
---

<div class="page-actions" data-pagefind-ignore>
  <button
    class="page-action-button copy-markdown-button"
    type="button"
    data-action="copy-markdown"
    data-slug={finalSlug}
    data-text-default={copyMarkdownText}
    data-text-copying={copyingText}
    data-text-success={copiedText}
    data-text-error={errorText}
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="16"
      height="16"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="page-action-icon icon-copy"
    >
      <rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>
      <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
    </svg>
    <span class="icon-check" style="display: none;">
      <IconCheck size={16} />
    </span>
    <span class="button-text">{copyMarkdownText}</span>
  </button>

  <DropDownMenu links={aiLinks} class="ask-ai-menu">
    <span>{askAIText}</span>
  </DropDownMenu>
</div>

<script>
  // Copy markdown functionality
  document.addEventListener('DOMContentLoaded', () => {
    const copyButton = document.querySelector('[data-action="copy-markdown"]') as HTMLButtonElement;

    if (!copyButton) return;

    copyButton.addEventListener('click', async () => {
      let slug = copyButton.dataset.slug ?? "";
      slug = slug.replace(/^\/+|\/+$/g, "");

      if (!slug) {
        console.error('No slug found');
        return;
      }

      const iconCopy = copyButton.querySelector('.icon-copy') as SVGElement;
      const iconCheck = copyButton.querySelector('.icon-check') as HTMLElement;
      const buttonText = copyButton.querySelector('.button-text') as HTMLElement;
      const fallbackText = buttonText?.textContent ?? '';
      const textDefault = copyButton.dataset.textDefault ?? fallbackText;
      const textCopying = copyButton.dataset.textCopying ?? fallbackText;
      const textSuccess = copyButton.dataset.textSuccess ?? fallbackText;
      const textError = copyButton.dataset.textError ?? fallbackText;

      try {
        // Disable button during fetch
        copyButton.disabled = true;
        if (buttonText) {
          buttonText.textContent = textCopying;
        }

        // Fetch the markdown content for the current page
        const searchParams = new URLSearchParams({
          stripFrontmatter: "1",
          removeImports: "1",
        });
        const response = await fetch(`/raw/${slug}?${searchParams.toString()}`);

        if (!response.ok) {
          throw new Error(`Failed to fetch markdown: ${response.statusText}`);
        }

        const markdownContent = await response.text();

        // Copy to clipboard
        await navigator.clipboard.writeText(markdownContent);

        // Show success state
        copyButton.classList.add('success');
        iconCopy.style.display = 'none';
        iconCheck.style.display = 'inline-block';
        if (buttonText) {
          buttonText.textContent = textSuccess;
        }

        // Reset after 2 seconds
        setTimeout(() => {
          copyButton.classList.remove('success');
          iconCopy.style.display = 'inline-block';
          iconCheck.style.display = 'none';
          if (buttonText) {
            buttonText.textContent = textDefault;
          }
          copyButton.disabled = false;
        }, 2000);

      } catch (error) {
        console.error('Error copying markdown:', error);

        // Show error state
        copyButton.classList.add('error');
        if (buttonText) {
          buttonText.textContent = textError;
        }

        // Reset after 2 seconds
        setTimeout(() => {
          copyButton.classList.remove('error');
          if (buttonText) {
            buttonText.textContent = textDefault;
          }
          copyButton.disabled = false;
        }, 2000);
      }
    });
  });
</script>

<style>
  .page-actions {
    display: flex;
    flex-direction: row;
    gap: 0.5rem;
    align-items: center;
    padding-bottom: 1.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid var(--theme-divider);
  }

  .page-action-button,
  :global(.ask-ai-menu) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    line-height: 1.25rem;
    border-radius: 0.375rem;
    border: 1px solid var(--theme-divider);
    background-color: var(--theme-bg-offset);
    color: var(--theme-text);
    cursor: pointer;
    transition: all 0.15s ease-in-out;
    user-select: none;
  }

  .page-action-button:hover,
  :global(.ask-ai-menu:hover) {
    background-color: var(--theme-bg-hover);
    border-color: var(--theme-accent);
  }

  .page-action-button:active {
    transform: translateY(1px);
  }

  .page-action-button:focus-visible {
    outline: 2px solid var(--theme-accent);
    outline-offset: 2px;
  }

  .page-action-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  .page-action-icon,
  .icon-check {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
    opacity: 0.7;
    display: inline-block;
  }

  .icon-check {
    line-height: 0;
  }

  /* Success state */
  .page-action-button.success {
    background-color: var(--theme-admonition-tip-bg);
    border-color: var(--theme-admonition-tip-border);
    color: var(--theme-admonition-tip-border);
  }

  /* Error state */
  .page-action-button.error {
    background-color: var(--theme-admonition-error-bg);
    border-color: var(--theme-admonition-error-border);
    color: var(--theme-admonition-error-border);
  }

  :global(.ask-ai-menu .menu-button) {
    padding: 0;
    background: transparent;
    border: none;
    gap: 0.5rem;
    display: flex;
    align-items: center;
    color: inherit;
  }

  :global(.ask-ai-menu .flyout) {
    top: 120%;
    left: 0;
    right: auto;
  }

  /* Mobile adjustments */
  @media (max-width: 640px) {
    .page-actions {
      gap: 0.375rem;
    }

    .page-action-button,
    :global(.ask-ai-menu) {
      padding: 0.25rem 0.5rem;
      font-size: 0.813rem;
    }

    .page-action-icon {
      width: 0.875rem;
      height: 0.875rem;
    }
  }
</style>
