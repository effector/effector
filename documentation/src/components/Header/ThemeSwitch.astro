---
import ThemeAuto from "@icons/ThemeAuto.astro";
import ThemeDark from "@icons/ThemeDark.astro";
import ThemeLight from "@icons/ThemeLight.astro";
---

<theme-switch class="theme-switch relative">
  <button type="button" class="toggle-button">
    <ThemeLight class="icon icon-light" />
    <ThemeAuto class="icon icon-auto" />
    <ThemeDark class="icon icon-dark" />
  </button>
</theme-switch>

<script>
  import { createStore, createEvent, combine } from "effector";

  function watchMedia(media: string) {
    const matcher = window.matchMedia(media);
    const changed = createEvent<MediaQueryListEvent>();

    const $matches = createStore(matcher.matches);
    $matches.on(changed, (_, event) => event.matches);

    matcher.addEventListener("change", changed);

    return { $matches, changed };
  }

  class ThemeSwitch extends HTMLElement {
    toggleThemePressed = createEvent();

    systemDarkTheme = watchMedia("(prefers-color-scheme: dark)");
    $theme = createStore(readTheme());
    $isDark = combine(this.$theme, this.systemDarkTheme.$matches, (theme, systemDark) => {
      if (theme === "auto") return systemDark;
      return theme === "dark";
    });

    connectedCallback() {
      this.setupToggle();

      this.$theme.on(this.toggleThemePressed, (theme) => {
        const themeIndex = allowedThemeValues.indexOf(theme);
        const nextTheme = allowedThemeValues[(themeIndex + 1) % allowedThemeValues.length];
        return nextTheme as Theme;
      });

      this.$theme.watch((theme) => {
        saveTheme(theme);
        this.updateIcon(theme);
      });

      this.$isDark.watch((dark) => {
        if (dark) document.documentElement.classList.add("theme-dark");
        else document.documentElement.classList.remove("theme-dark");
      });
    }

    setupToggle() {
      const toggle = this.querySelector(".toggle-button") as HTMLButtonElement;
      toggle.addEventListener("click", () => this.toggleThemePressed());
      this.updateIcon(this.$theme.getState());
    }

    updateIcon(theme: Theme) {
      const icons = this.querySelectorAll(".icon");
      icons.forEach((icon) => {
        icon.classList.add("hidden");
      });
      const activeIcon = this.querySelector(`.icon-${theme}`);
      if (activeIcon) {
        activeIcon.classList.remove("hidden");
      }
    }
  }

  type Theme = "dark" | "light" | "auto";
  const allowedThemeValues: string[] = ["dark", "light", "auto"] satisfies Theme[];

  function normalizeTheme(input: string | null, defaultValue: Theme = "auto"): Theme {
    if (input && allowedThemeValues.includes(input)) {
      return input as Theme;
    }
    return defaultValue;
  }

  function readTheme(defaultValue: Theme = "auto"): Theme {
    if (typeof localStorage !== undefined) {
      const storedValue = localStorage.getItem("theme");
      return normalizeTheme(storedValue, defaultValue);
    }
    return defaultValue;
  }

  function saveTheme(theme: Theme) {
    if (typeof localStorage !== undefined) {
      localStorage.setItem("theme", theme);
    }
  }

  customElements.define("theme-switch", ThemeSwitch);
</script>

<style>
  .theme-switch {
    @apply flex min-h-8 min-w-10 items-center justify-center rounded-full;
    background-color: var(--theme-secondary-bg);
  }

  .toggle-button {
    @apply flex cursor-pointer items-center justify-center p-2;
    color: var(--theme-accent);
    background: transparent;
    border: none;
  }

  .toggle-button:hover {
    opacity: 0.8;
  }

  .toggle-button:focus {
    outline: none;
    @apply ring-1 ring-current ring-offset-2;
  }

  .icon {
    display: block;
  }

  .icon.hidden {
    display: none;
  }
</style>
